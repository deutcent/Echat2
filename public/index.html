<!--  =================================================================
      Echat ‚Äì FULL CLIENT (HTML + CSS + JS)
      Features:
        ‚Ä¢ Password login
        ‚Ä¢ Contenteditable chat box (GIF keyboards work)
        ‚Ä¢ Long-press / right-click emoji + delete palette
        ‚Ä¢ Smart palette positioning (never off-screen)
        ‚Ä¢ GIF support on mobile (accept="image/gif ‚Ä¶")
        ‚Ä¢ Clipboard paste (image + GIF)
        ‚Ä¢ File upload (images, GIF, docs, video)
        ‚Ä¢ Voice push-to-talk
        ‚Ä¢ Typing indicator, online count
        ‚Ä¢ Clear-all-chat
        ‚Ä¢ Reactions, message delete
        ‚Ä¢ All UI styling preserved
      ================================================================= -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport"
      content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Echat</title>
<style>
/* ---------- 1. Layout ---------- */
*{box-sizing:border-box}html,body{margin:0;padding:0;height:100%}
body{display:flex;justify-content:center;align-items:center;font-family:sans-serif;
     background:#ece5dd}
/* phone safe-area */
#chat-container{width:100%;max-width:500px;height:100vh;display:flex;
                flex-direction:column;background:#fff}

/* ---------- 2. Header ---------- */
header{display:flex;justify-content:space-between;align-items:center;
       background:#075e54;color:#fff;padding:10px;font-weight:700}
#user-list{padding:5px 10px;background:#f4f4f4;font-size:.9em;color:#333}

/* ---------- 3. Message Area ---------- */
#messages{flex:1;padding:10px 8px;overflow-y:auto;background:#dcf8c6}
.message{max-width:75%;margin:4px 0;padding:8px 12px;border-radius:10px;
         position:relative;box-shadow:0 1px 2px rgba(0,0,0,.1);cursor:pointer;
         user-select:none;clear:both;word-wrap:break-word}
.sender{float:right;background:#dcf8c6;border:1px solid #bfe6b0;text-align:right}
.receiver{float:left;background:#fff;border:1px solid #e0e0e0}
.username{font-weight:700;color:#075e54;font-size:.88em}
.timestamp{display:block;font-size:.7em;color:#666;margin-top:2px}
img.chat-image{max-width:100%;border-radius:10px;margin-top:5px}
a.download-link{display:inline-block;margin-top:4px;font-size:.85em;color:#07f}

/* Reactions */
.reactions{margin-top:5px}
.reaction{display:inline-block;font-size:16px;margin-right:5px;padding:1px 3px;
          border:1px solid #ddd;border-radius:11px;background:rgba(255,255,255,.8)}

/* ---------- 4. Input bar ---------- */
#form{display:flex;gap:6px;padding:10px;background:#f0f0f0;align-items:center}
#file-input{display:none}
#file-input-label,#voice-btn,button[type=submit]
  {background:#25D366;color:#fff;border:none;padding:10px;border-radius:50%;
   font-size:16px;cursor:pointer;transition:.15s}
#file-input-label:hover,#voice-btn:hover,button[type=submit]:hover{background:#1aa84c}
#voice-btn.speaking{background:red;animation:pulse 1s infinite}
/* typing box */
.chat-input{flex:1;min-height:42px;max-height:100px;overflow-y:auto;
            padding:10px;border:1px solid #ccc;border-radius:20px;
            outline:none;font-size:15px}
.chat-input:empty::before{content:attr(data-placeholder);color:#999}
/* placeholder caret fix */
.chat-input br{line-height:0}

/* clear chat */
#clear-chat-btn{margin:5px 10px;padding:5px 10px;border:none;background:red;
                color:#fff;border-radius:5px;cursor:pointer}
#clear-chat-btn:hover{background:#c00}

/* ---------- 5. Reaction palette ---------- */
.palette{position:fixed;z-index:1000;background:#fff;border:1px solid #ccc;
         border-radius:12px;padding:8px 10px;display:flex;flex-wrap:wrap;gap:8px;
         box-shadow:0 4px 12px rgba(0,0,0,.18);animation:fade .2s ease-out}
.palette button{background:none;border:none;font-size:24px;cursor:pointer;
               transition:transform .12s}
.palette button:hover{transform:scale(1.25)}
.palette .delete-btn{font-size:18px;color:#d00}
@keyframes fade{from{opacity:0;transform:scale(.85)}to{opacity:1;transform:scale(1)}}
@keyframes pulse{0%{transform:scale(1);opacity:1}50%{transform:scale(1.2);opacity:.6}100%{transform:scale(1);opacity:1)}
</style>
</head>
<body>
<div id="chat-container">
  <header>Echat  <span id="online-count">Online 0</span></header>
  <div id="user-list">Users:</div>
  <button id="clear-chat-btn">üßπ Clear All Chat</button>
  <div id="messages"></div>

  <form id="form" autocomplete="off">
    <label id="file-input-label" for="file-input">üìé</label>
    <!-- GIF row enabled on Android & iOS -->
    <input id="file-input" type="file"
           accept="image/gif,image/*,.gif,.pdf,.doc,.docx,.txt,.mp4">
    <button type="button" id="voice-btn">üé§</button>
    <div id="input" class="chat-input" contenteditable="true"
         data-placeholder="Type a message‚Ä¶"></div>
    <button type="submit">‚û§</button>
  </form>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
/* ========== 0. Login ========== */
const socket = io();
let name='',pass='';
while(pass!=='stroracle') pass=prompt('Enter password to join:');
while(!name) name=prompt('Enter your name:');
socket.emit('user joined',name);

/* ========== 1. DOM refs ========== */
const messages=document.getElementById('messages'),
      input   =document.getElementById('input'),
      fileIn  =document.getElementById('file-input'),
      voiceBtn=document.getElementById('voice-btn'),
      online  =document.getElementById('online-count'),
      userList=document.getElementById('user-list');

/* ========== 2. Helpers ========== */
const scrollBottom=()=>messages.scrollTop=messages.scrollHeight;

/* 2-A. Smart reaction palette */
function showPalette(x,y,id,isSender){
  document.querySelectorAll('.palette').forEach(p=>p.remove());
  const pal=document.createElement('div');pal.className='palette';
  '‚ù§Ô∏è üòÇ üëç üòÆ üò¢'.split(' ').forEach(emo=>{
    const b=document.createElement('button');b.textContent=emo;
    b.onclick=()=>{socket.emit('react message',{id,emoji:emo,name});pal.remove();};
    pal.appendChild(b);
  });
  if(isSender){
    const d=document.createElement('button');d.textContent='üóëÔ∏è';d.className='delete-btn';
    d.onclick=()=>{socket.emit('delete message',id);pal.remove();};
    pal.appendChild(d);
  }
  pal.style.visibility='hidden';document.body.appendChild(pal);
  const r=pal.getBoundingClientRect(),vw=innerWidth,vh=innerHeight;
  let fx=Math.min(Math.max(10,x),vw-r.width-10),
      fy=y+r.height>vh?y-r.height-10:y;
  if(fy<10) fy=10;
  pal.style.left=fx+'px';pal.style.top=fy+'px';pal.style.visibility='visible';
  const closer=e=>!pal.contains(e.target)&&(pal.remove(),document.removeEventListener('click',closer));
  setTimeout(()=>document.addEventListener('click',closer),10);
  document.addEventListener('keydown',e=>e.key==='Escape'&&pal.remove(),{once:true});
}

/* 2-B. Attach gestures (touch-hold / right-click) */
function attachGestures(div,isSender){
  let t,start=e=>{
    const p=e.touches?e.touches[0]:e;
    t=setTimeout(()=>showPalette(p.clientX,p.clientY,div.dataset.id,isSender),500);
  },stop=()=>clearTimeout(t);
  ['touchstart','mousedown'].forEach(ev=>div.addEventListener(ev,start));
  ['touchend','touchmove','mouseup','mouseleave'].forEach(ev=>div.addEventListener(ev,stop));
  div.addEventListener('contextmenu',e=>{e.preventDefault();showPalette(e.clientX,e.clientY,div.dataset.id,isSender);});
}

/* 2-C. Create message bubble */
function addBubble(d,me){
  const div=document.createElement('div');
  div.className='message ' + (me?'sender':'receiver');
  div.dataset.id=d.id;
  let html=`<span class="username">${d.name}</span>${d.message||''}`;
  if(d.type==='image'||d.type==='gif'){
    html+=`<br><img class="chat-image" src="${d.url}">`+
          `<br><a class="download-link" href="${d.url}" download>‚¨áÔ∏è Download</a>`;
  }else if(d.type==='file'){
    html+=`<div>üìÑ ${d.filename}</div><a class="download-link" href="${d.url}" download>‚¨áÔ∏è Download</a>`;
  }
  html+=`<span class="timestamp">${new Date(d.timestamp).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</span>`;
  if(d.reactions&&Object.keys(d.reactions).length){
    html+=`<div class="reactions">${Object.values(d.reactions).map(e=>`<span class="reaction">${e}</span>`).join('')}</div>`;
  }
  div.innerHTML=html;messages.appendChild(div);attachGestures(div,me);scrollBottom();
}

/* ========== 3. Send text (Enter) ========== */
input.addEventListener('keydown',e=>{
  if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();
    const txt=input.innerText.trim();if(!txt)return;
    const msg={id:Date.now().toString(),name,message:txt,timestamp:Date.now()};
    socket.emit('chat message',msg);addBubble(msg,true);input.innerHTML='';
  }
});

/* ========== 4. File picker ========== */
fileIn.addEventListener('change',()=>{
  const f=fileIn.files[0];if(!f)return;
  const fd=new FormData();fd.append('file',f);
  fetch('/upload',{method:'POST',body:fd}).then(r=>r.json()).then(o=>{
    const m={id:Date.now().toString(),name,url:o.fileUrl,filename:f.name,
             type:f.type==='image/gif'?'gif':f.type.startsWith('image/')?'image':'file',
             timestamp:Date.now()};
    socket.emit(m.type==='file'?'chat file':'chat image',m);addBubble(m,true);
  });fileIn.value='';
});

/* ========== 5. Clipboard paste ========== */
document.addEventListener('paste',async e=>{
  const it=[...e.clipboardData.items].find(i=>i.type.startsWith('image/'));
  if(!it)return;e.preventDefault();
  const fd=new FormData();fd.append('file',it.getAsFile(),'clip');
  const o=await (await fetch('/upload',{method:'POST',body:fd})).json();
  const m={id:Date.now().toString(),name,url:o.fileUrl,type:it.type==='image/gif'?'gif':'image',
           timestamp:Date.now()};socket.emit('chat image',m);addBubble(m,true);
});

/* ========== 6. Socket events ========== */
socket.on('previous messages',arr=>arr.forEach(m=>addBubble(m,m.name===name)));
socket.on('chat message',d=>d.name!==name&&addBubble(d,false));
socket.on('chat image', d=>d.name!==name&&addBubble(d,false));
socket.on('chat file',  d=>d.name!==name&&addBubble(d,false));
socket.on('delete message',id=>document.querySelector(`[data-id="${id}"]`)?.remove());
socket.on('react message',({id,reactions})=>{
  const el=document.querySelector(`[data-id="${id}"]`);if(!el)return;
  let r=el.querySelector('.reactions');
  if(Object.keys(reactions).length){
    const html=Object.values(reactions).map(e=>`<span class="reaction">${e}</span>`).join('');
    (r||(r=el.appendChild(Object.assign(document.createElement('div'),{className:'reactions'}))))
      .innerHTML=html;
  }else r?.remove();
});
socket.on('user joined',u=>messages.appendChild(Object.assign(document.createElement('div'),{className:'system',textContent:`${u} joined`})));
socket.on('user left', u=>messages.appendChild(Object.assign(document.createElement('div'),{className:'system',textContent:`${u} left`})));
socket.on('typing',u=>{if(u!==name){userList.textContent=`${u} is typing‚Ä¶`;clearTimeout(window.t);window.t=setTimeout(()=>userList.textContent='',2000);}});
socket.on('online users',d=>online.textContent=`Online ${d.count}`);
document.getElementById('clear-chat-btn').onclick=()=>confirm('Clear chat for everyone?')&&socket.emit('clear all chat');
socket.on('clear all chat',()=>messages.innerHTML='');

/* ========== 7. Voice push-to-talk (unchanged) ========== */
// add your previous voice-stream code here ...
</script>
</body>
</html>
